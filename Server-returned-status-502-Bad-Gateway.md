# Soundness Submission Diagnostic Report

## Overview
On 2025-10-05 we attempted to submit an SP1 Groth16 proof‚Äîgenerated by the ConnectSphere backend‚Äîto Soundness Layer via `soundness-cli`. The CLI signs and delivers the payload successfully, but the server consistently responds with HTTP 502. All local validations confirm that the referenced Walrus blobs are publicly accessible on mainnet. This report documents each step and the evidence we gathered so the Soundness team can quickly pinpoint the failure on their side.

## Environment Summary
- **Host machine**: Linux (root@vmi2640956)
- **Project root**: `/root/1111111/connectsphere_new`
- **ConnectSphere backend**: `/root/1111111/connectsphere_new/backend`
- **SP1 repository**: `/root/SP1/sp1`
- **Soundness CLI repo**: `/root/SP1/soundness-layer/soundness-cli`
- **Soundness CLI version**: 0.1.2 (built locally, installed to `~/.cargo/bin`)
- **Walrus CLI version**: 1.34.0-6cf292509809
- **Sui CLI version**: 1.57.0 (testnet branch)
- **Walrus contexts**:
  ```yaml
  default_context: mainnet
  contexts:
    mainnet:
      rpc_urls: ["https://fullnode.mainnet.sui.io:443"]
      wallet_config.active_env: mainnet
    testnet:
      rpc_urls: ["https://fullnode.testnet.sui.io:443"]
      wallet_config.active_env: testnet
  ```

## Proof Generation Pipeline
1. Backend invokes the SP1 script located at `/root/1111111/connectsphere_new/backend/sp1/script/src/main.rs` with the user‚Äôs Clerk JWT, Google public key, expected domain, and Sui address.
2. SP1 program verifies the JWT signature, extracts the email, checks the domain, and commits the Sui address as public data.
3. Proof artifacts are emitted as:
   - `proof.bin` (~30 MB)
   - `connectsphere-sp1-program.elf` (~0.6 MB)
4. Backend converts and verifies the proof using `sp1_sui::convert_sp1_gnark_to_ark`, then uploads both files to Walrus (`src/services/walrus.ts`).
5. The queue service stores metadata and generates the CLI command string (`src/lib/queue.ts:272-316`).

## Walrus Upload Details (Mainnet)
```
walrus store --context mainnet /root/proof-test/proof.bin --epochs 1 --deletable
```
Output excerpt:
```
Blob ID: 31nnUTjDiwE9YDwYprOeLsF-Q529a4o8JOuGVrP_x0M
Sui object ID: 0x3f1d6f193d2c567634d9db4c2bb1003cf5c90277eca6ae73dad200535b10c5a7
Unencoded size: 29.9 MiB
Encoded size: 197 MiB
Cost: 0 FROST (reuse registration)
```
Corresponding ELF blob (uploaded on Walrus mainnet as well):
```
Blob ID: MExTNCeUcJGjfoxWTTlOTLK0EasWkFvJ382dpxLcESQ
Sui object ID: 0x38b068f844ff1183e94df8b3fe1ea8dd7172f03612815939502857bf5e7692d5
Unencoded size: 625 KiB
Encoded size: 64.9 MiB
```

## Artifact Availability Checks
### Host Verification
```
curl -I https://aggregator.walrus.network/v1/blobs/31nnUTjDiwE9YDwYprOeLsF-Q529a4o8JOuGVrP_x0M
HTTP/2 200 ...
content-length: 31313911

curl -I https://aggregator.walrus.network/v1/blobs/MExTNCeUcJGjfoxWTTlOTLK0EasWkFvJ382dpxLcESQ
HTTP/2 200 ...
content-length: 640000
```
### Backend Container Verification
```
docker exec connectsphere_new-backend-1 \
  curl -I https://aggregator.walrus.network/v1/blobs/31nnUTjDiwE9YDwYprOeLsF-Q529a4o8JOuGVrP_x0M
HTTP/2 200 ... cf-cache-status: HIT
```
### Local Download (Sanity Check)
```
walrus read --context mainnet --out /root/proof-test/proof.bin 31nnUTjDiwE9YDwYprOeLsF-Q529a4o8JOuGVrP_x0M
walrus read --context mainnet --out /root/proof-test/elf.bin   MExTNCeUcJGjfoxWTTlOTLK0EasWkFvJ382dpxLcESQ
```
Both commands succeed and the files match the originals.

## Soundness CLI Submission
Command:
```bash
soundness-cli send \
  --proof-file 31nnUTjDiwE9YDwYprOeLsF-Q529a4o8JOuGVrP_x0M \
  --elf-file   MExTNCeUcJGjfoxWTTlOTLK0EasWkFvJ382dpxLcESQ \
  --key-name   NS \
  --proving-system sp1 \
  --payload '{
    "session_id":"sess_1759626055899_user_33YvZvV7syoylzCFkqPaBYkXPIO",
    "clerk_user_id":"user_33YvZvV7syoylzCFkqPaBYkXPIO",
    "expected_domain":"gmail.com",
    "sui_address":"0xc6713f4e522e46958bb0616956ab92dded8a1e746430341dda1a86082c942b9e"
  }'
```
Observations:
- The CLI recognizes both arguments as Walrus blob IDs.
- Key `NS` exists in `key_store.json`; signing succeeds after password entry.
- Final CLI output:
  ```
  ‚úÖ Payload signed successfully
  üöÄ Request sent successfully
  ‚ùå Error: Server returned status 502 Bad Gateway
  Error details: error code: 502
  ```
- Timestamp of latest attempt: **2025-10-05 ~01:44 UTC**

## Additional Tests
- Direct upload of proof as a local file (~30 MB) was rejected earlier with `413 Request Entity Too Large`. This confirms the back-end limits Nginx request size; hence we rely on Walrus blob IDs, which are far smaller.
- The ConnectSphere backend and worker queue were restarted using `docker compose -f compose.yaml -f compose.prod.yaml up -d` to ensure no stale containers occupy ports.
- Proof generation and uploading were repeated to confirm there are no transient issues; results are consistent.

## Conclusion
All artifacts, signatures, and payloads are valid and publicly accessible. The failure occurs after the request reaches `https://testnet.soundness.xyz/api/proof`, indicating the Soundness backend cannot retrieve the Walrus blob or process it. There are no code or configuration changes left on our side that can resolve the issue.

## Requests for the Soundness Team
1. **Inspect server logs** around 2025-10-05T01:44 UTC for the submission with blob ID `31nnUTjDiwE9YDwYprOeLsF-Q529a4o8JOuGVrP_x0M`.
2. **Confirm aggregator endpoint configuration**: ensure production fetcher points to the Walrus **mainnet** aggregator (`https://aggregator.walrus.network`) and can resolve Cloudflare DNS.
3. **Validate fetch from server-side**: run a `curl -I` or equivalent from the Soundness backend environment to the blob URL to verify connectivity.
4. **Check request size and timeouts**: confirm there are no additional limits or early timeouts when downloading ¬±30 MB blobs.
